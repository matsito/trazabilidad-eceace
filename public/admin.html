<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Equipos | ECEACE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { background-color: #f0f2f5; }
        .admin-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .nav-pills .nav-link.active { background-color: #0d6efd; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">ECEACE <strong>Gesti√≥n</strong></span>
            <a href="/" class="btn btn-outline-light btn-sm">Ir al Dashboard</a>
        </div>
    </nav>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                
                <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-crear" data-bs-toggle="pill" data-bs-target="#panel-crear" type="button">‚ú® Crear Nuevo</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-editar" data-bs-toggle="pill" data-bs-target="#panel-editar" type="button">üõ†Ô∏è Actualizar Existente</button>
                    </li>
                </ul>

                <div class="tab-content" id="pills-tabContent">
                    
                    <div class="tab-pane fade show active" id="panel-crear">
                        <div class="admin-card">
                            <h4 class="mb-4 text-center">Registrar Equipo y Generar QR</h4>
                            <form id="form-crear">
                                <div class="mb-3"><label>Nombre</label><input type="text" id="c-nombre" class="form-control" required></div>
                                <div class="mb-3"><label>Ubicaci√≥n</label><input type="text" id="c-ubicacion" class="form-control" required></div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label>Estado Inicial</label>
                                        <select id="c-estado" class="form-select">
                                            <option value="OPERATIVO">üü¢ OPERATIVO</option>
                                            <option value="FALLA CR√çTICA">üî¥ FALLA CR√çTICA</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label>Fecha Revisi√≥n</label>
                                        <input type="datetime-local" id="c-fecha" class="form-control">
                                        <small class="text-muted">Dejar vac√≠o para usar "Ahora"</small>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 btn-lg">Guardar y Crear QR</button>
                            </form>
                            
                            <div id="resultado-qr" class="mt-4 text-center d-none border-top pt-3">
                                <h5 class="text-success">¬°Creado! ID: <span id="new-id"></span></h5>
                                <div id="qrcode" class="d-flex justify-content-center my-3"></div>
                                <button onclick="location.reload()" class="btn btn-sm btn-outline-secondary">Limpiar</button>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="panel-editar">
                        <div class="admin-card border-warning border-top border-4">
                            <h4 class="mb-4 text-center">Actualizar Equipo</h4>
                            
                            <div class="input-group mb-4">
                                <input type="number" id="buscar-id" class="form-control" placeholder="Ingresa el ID del equipo (ej: 1)">
                                <button class="btn btn-dark" onclick="buscarEquipo()">üîç Buscar</button>
                            </div>

                            <div id="form-editar-container" class="d-none">
                                <form id="form-editar">
                                    <input type="hidden" id="e-id">
                                    <div class="mb-3"><label>Nombre</label><input type="text" id="e-nombre" class="form-control"></div>
                                    <div class="mb-3"><label>Ubicaci√≥n</label><input type="text" id="e-ubicacion" class="form-control"></div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Estado Actual</label>
                                            <select id="e-estado" class="form-select">
                                                <option value="OPERATIVO">üü¢ OPERATIVO</option>
                                                <option value="FALLA CR√çTICA">üî¥ FALLA CR√çTICA</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Nueva Fecha Revisi√≥n</label>
                                            <input type="datetime-local" id="e-fecha" class="form-control">
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-warning w-100 fw-bold">Guardar Cambios</button>
                                </form>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // === LOGICA PARA CREAR ===
        document.getElementById('form-crear').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                nombre: document.getElementById('c-nombre').value,
                ubicacion: document.getElementById('c-ubicacion').value,
                estado: document.getElementById('c-estado').value,
                ultima_revision: document.getElementById('c-fecha').value || new Date()
            };

            const res = await fetch('/api/equipos', {
                method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data)
            });
            const json = await res.json();
            
            if(json.id) {
                document.getElementById('resultado-qr').classList.remove('d-none');
                document.getElementById('new-id').innerText = json.id;
                document.getElementById('qrcode').innerHTML = ""; // Limpiar anterior
                new QRCode(document.getElementById("qrcode"), {
                    text: `${window.location.origin}/detalle?id=${json.id}`,
                    width: 150, height: 150
                });
            }
        });

        // === LOGICA PARA BUSCAR Y EDITAR ===
        async function buscarEquipo() {
            const id = document.getElementById('buscar-id').value;
            if(!id) return alert("Escribe un ID");

            const res = await fetch(`/api/equipos/${id}`);
            if(!res.ok) return alert("Equipo no encontrado");

            const equipo = await res.json();
            
            // Rellenar formulario
            document.getElementById('form-editar-container').classList.remove('d-none');
            document.getElementById('e-id').value = equipo.id;
            document.getElementById('e-nombre').value = equipo.nombre;
            document.getElementById('e-ubicacion').value = equipo.ubicacion;
            document.getElementById('e-estado').value = equipo.estado;
            
            // Formatear fecha para el input (truco t√©cnico para que el input date lo lea)
            if(equipo.ultima_revision) {
                const dateObj = new Date(equipo.ultima_revision);
                dateObj.setMinutes(dateObj.getMinutes() - dateObj.getTimezoneOffset());
                document.getElementById('e-fecha').value = dateObj.toISOString().slice(0,16);
            }
        }

        document.getElementById('form-editar').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('e-id').value;
            const data = {
                nombre: document.getElementById('e-nombre').value,
                ubicacion: document.getElementById('e-ubicacion').value,
                estado: document.getElementById('e-estado').value,
                ultima_revision: document.getElementById('e-fecha').value
            };

            const res = await fetch(`/api/equipos/${id}`, {
                method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data)
            });

            if(res.ok) {
                alert("‚úÖ Equipo actualizado correctamente. El QR ahora mostrar√° los nuevos datos.");
                location.reload();
            } else {
                alert("Error al actualizar");
            }
        });
    </script>

</body>
</html>